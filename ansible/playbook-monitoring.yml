---
- name: DÃ©ployer le stack de monitoring
  hosts: localhost
  gather_facts: no
  
  vars:
    monitoring_namespace: monitoring
    helm_release: monitoring-stack
    helm_chart_path: "../helm/charts/monitoring"
    values_file_path: "../helm/charts/monitoring/values.yaml"
    
  tasks:
    - name: CrÃ©er le namespace monitoring
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ monitoring_namespace }}"
    
    - name: Installer les CRDs Prometheus Operator (server-side)
      ansible.builtin.command:
        cmd: kubectl apply --server-side -f {{ item }}
      loop:
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_podmonitors.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_probes.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_prometheusrules.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_servicemonitors.yaml
        - https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.70.0/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
        
    - name: DÃ©ployer le chart Helm monitoring
      kubernetes.core.helm:
        release_name: "{{ helm_release }}"
        chart_ref: "{{ helm_chart_path }}"
        release_namespace: "{{ monitoring_namespace }}"
        create_namespace: false
        values_files:
          - "{{ values_file_path }}"
        state: present
        wait: true
        wait_timeout: 5m
    
    - name: Attendre que Prometheus soit prÃªt
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ monitoring_namespace }}"
        label_selectors:
          - "app.kubernetes.io/name=prometheus"
      register: prometheus_pods
      until: prometheus_pods.resources | length > 0 and prometheus_pods.resources[0].status.phase == "Running"
      retries: 30
      delay: 10
      ignore_errors: yes
    
    - name: Attendre que Grafana soit prÃªt
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ monitoring_namespace }}"
        label_selectors:
          - "app=grafana"
      register: grafana_pods
      until: grafana_pods.resources | length > 0 and grafana_pods.resources[0].status.phase == "Running"
      retries: 30
      delay: 10
      ignore_errors: yes
    
    - name: RÃ©cupÃ©rer l'IP du nÅ“ud
      ansible.builtin.command:
        cmd: kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}'
      register: node_ip_result
      changed_when: false
    
    - name: Afficher les URLs d'accÃ¨s
      ansible.builtin.debug:
        msg:
          - "=== ğŸ“Š Monitoring Stack dÃ©ployÃ© avec succÃ¨s ==="
          - ""
          - "ğŸ” Prometheus: http://{{ node_ip_result.stdout }}:30090"
          - "ğŸ“ˆ Grafana: http://{{ node_ip_result.stdout }}:30300"
          - "   Username: admin"
          - "   Password: admin123"
          - ""
          - "ğŸ“¡ Node Exporter: http://{{ node_ip_result.stdout }}:30100/metrics"
          - ""
          - "VÃ©rifier les ServiceMonitors:"
          - "  kubectl get servicemonitor -A"
