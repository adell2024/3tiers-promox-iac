---
- name: Déployer l'infrastructure applicative 3-tiers (Mode GitOps)
  hosts: localhost
  gather_facts: no

  vars:
    kube_namespace: my-app
    helm_release: my-app

    postgres_db: myappdb
    postgres_user: appuser
    postgres_password: "{{ lookup('env','PG_PASSWORD') | default('changeme', true) }}"

    dockerhub_username: "{{ lookup('env','DOCKERHUB_USERNAME') | default('', true) }}"
    dockerhub_password: "{{ lookup('env','DOCKERHUB_PASSWORD') | default('', true) }}"

    clean_deploy: false

  tasks:

    # --- PHASE 1 : NETTOYAGE ---
    - name: Nettoyer le namespace si clean_deploy est vrai
      when: clean_deploy | bool
      block:
        - name: Supprimer le namespace existant
          kubernetes.core.k8s:
            state: absent
            api_version: v1
            kind: Namespace
            name: "{{ kube_namespace }}"

        - name: Attendre la suppression effective
          ansible.builtin.pause:
            seconds: 45

    # --- PHASE 2 : PRÉPARATION ---
    - name: Créer le namespace Kubernetes
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ kube_namespace }}"

    - name: Créer le secret PostgreSQL
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgres-secret
            namespace: "{{ kube_namespace }}"
          type: Opaque
          stringData:
            db-name: "{{ postgres_db }}"
            db-user: "{{ postgres_user }}"
            db-password: "{{ postgres_password }}"

    - name: Créer le secret DockerHub
      ansible.builtin.shell: |
        kubectl create secret docker-registry regcred \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="{{ dockerhub_username }}" \
          --docker-password="{{ dockerhub_password }}" \
          --namespace={{ kube_namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -
      when: dockerhub_username != '' and dockerhub_password != ''
      changed_when: true

    # --- PHASE 3 : APPLICATION ---
    - name: Enregistrer l'application dans ArgoCD
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: "{{ helm_release }}"
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: https://github.com/adell2024/3tiers-promox-iac.git
              targetRevision: HEAD
              path: helm/charts/my-app
            destination:
              server: https://kubernetes.default.svc
              namespace: "{{ kube_namespace }}"
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true

    # --- PHASE 3.5 : MONITORING ---
    - name: Déployer la stack de monitoring via ArgoCD
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: monitoring-stack
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: https://prometheus-community.github.io/helm-charts
              chart: kube-prometheus-stack
              targetRevision: "45.7.1"
              helm:
                values: |
                  prometheus:
                    enabled: true
                    prometheusSpec:
                      storageSpec:
                        emptyDir: {}
            destination:
              server: https://kubernetes.default.svc
              namespace: monitoring
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
                - Replace=true
                - ServerSideApply=true


    - name: Créer l'instance Prometheus via manifest GitOps
      kubernetes.core.k8s:
        state: present
        src: "{{ playbook_dir }}/../argocd/monitoring/prometheus-instance.yaml"


    # --- PHASE 4 : AFFICHAGE ---
    - name: Attendre qu'ArgoCD crée les services
      ansible.builtin.pause:
        seconds: 10

    - name: Récupérer les services
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ kube_namespace }}"
      register: service_list

    - name: Afficher les informations d'accès
      ansible.builtin.debug:
        msg:
          - "Frontend: http://<NODE_IP>:{{ item.spec.ports[0].nodePort }}"
      loop: "{{ service_list.resources }}"
      when:
        - item.metadata.name == 'frontend'
        - item.spec.type == 'NodePort'
