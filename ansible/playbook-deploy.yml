---
- name: DÃ©ployer l'infrastructure applicative 3-tiers (Mode GitOps)
  hosts: localhost
  gather_facts: no
  vars:
    kube_namespace: my-app
    helm_release: my-app
    # Secrets PostgreSQL
    postgres_db: myappdb
    postgres_user: appuser
    postgres_password: "{{ lookup('env','PG_PASSWORD') | default('changeme', true) }}"
    # DockerHub credentials
    dockerhub_username: "{{ lookup('env','DOCKERHUB_USERNAME') | default('', true) }}"
    dockerhub_password: "{{ lookup('env','DOCKERHUB_PASSWORD') | default('', true) }}"
    clean_deploy: false

  tasks:
    # --- PHASE 1 : NETTOYAGE (Optionnel) ---
    - name: Nettoyer le namespace si clean_deploy est vrai
      when: clean_deploy | bool
      block:
        - name: Supprimer le namespace existant
          kubernetes.core.k8s:
            state: absent
            api_version: v1
            kind: Namespace
            name: "{{ kube_namespace }}"
        
        - name: Attendre la suppression effective (Ã©vite les conflits)
          ansible.builtin.pause:
            seconds: 45

    # --- PHASE 2 : PRÃ‰PARATION DE L'ENVIRONNEMENT ---
    - name: CrÃ©er le namespace Kubernetes
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ kube_namespace }}"

    - name: CrÃ©er le secret PostgreSQL
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgres-secret
            namespace: "{{ kube_namespace }}"
          type: Opaque
          stringData:
            db-name: "{{ postgres_db }}"
            db-user: "{{ postgres_user }}"
            db-password: "{{ postgres_password }}"

    - name: CrÃ©er le secret DockerHub
      ansible.builtin.shell: |
        kubectl create secret docker-registry regcred \
          --docker-server=https://index.docker.io/v1/ \
          --docker-username="{{ dockerhub_username }}" \
          --docker-password="{{ dockerhub_password }}" \
          --namespace={{ kube_namespace }} \
          --dry-run=client -o yaml | kubectl apply -f -
      when: dockerhub_username != '' and dockerhub_password != ''
      changed_when: true

    # --- PHASE 3 : DÃ‰LÃ‰GATION Ã€ ARGOCD (GITOPS) ---
    - name: Enregistrer l'application dans ArgoCD
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: "{{ helm_release }}"
            namespace: argocd
          spec:
            project: default
            source:
              repoURL: 'https://github.com/adell2024/3tiers-promox-iac.git'
              targetRevision: HEAD
              path: helm/charts/my-app
            destination:
              server: 'https://kubernetes.default.svc'
              namespace: "{{ kube_namespace }}"
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true

    # --- PHASE 4 : RÃ‰CUPÃ‰RATION DES INFOS ET AFFICHAGE ---
    - name: Attendre qu'ArgoCD crÃ©e les services
      ansible.builtin.pause:
        seconds: 10

    - name: RÃ©cupÃ©rer les services pour l'affichage
      kubernetes.core.k8s_info:
        kind: Service
        namespace: "{{ kube_namespace }}"
      register: service_list

    - name: Afficher les informations d'accÃ¨s
      ansible.builtin.debug:
        msg:
          - "=== APPLICATION DÃ‰PLOYÃ‰E ==="
          - "Frontend accessible sur: http://<NODE_IP>:{{ item.spec.ports[0].nodePort }}"
          - "========================================================="
          - "ðŸš€ APPLICATION DÃ‰PLOYÃ‰E EN HAUTE DISPONIBILITÃ‰"
          - "========================================================="
          - "AccÃ¨s via n'importe quel nÅ“ud du cluster sur le port 80 :"
          - "- http://10.0.0.11"
          - "- http://10.0.0.12"
          - "- http://10.0.0.13"
          - ""
          - "Endpoint API : /api/messages"
          - "========================================================="
          - "Pour obtenir l'IP du noeud: kubectl get nodes -o wide"
      loop: "{{ service_list.resources }}"
      when:
        - item.metadata.name == 'frontend'
        - item.spec.type == 'NodePort'
